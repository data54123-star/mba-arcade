<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MBA Derby Multiplayer</title>
    <style>
        body { 
            background-color: #000; 
            color: #fff; 
            font-family: 'Courier New', monospace; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh;
            overflow-x: hidden;
        }

        h1 { color: #00ff00; text-shadow: 0 0 10px rgba(0,255,0,0.5); margin: 60px 0 20px 0; font-size: 2rem; text-align: center;}
        .highlight { color: #ffff00; font-weight: bold; }
        
        /* HOME BUTTON */
        .btn-home {
            position: absolute; top: 15px; left: 15px; 
            background: #000; color: #00ff00; border: 1px solid #00ff00; 
            padding: 8px 12px; border-radius: 5px; cursor: pointer;
            font-family: 'Courier New', monospace; font-weight: bold; z-index: 1000;
            text-decoration: none; font-size: 1rem;
        }

        /* STATUS ANZEIGE */
        #status-display {
            position: absolute; top: 15px; right: 15px;
            padding: 8px 12px; border-radius: 5px; font-weight: bold; font-size: 0.9rem;
            z-index: 1000; border: 1px solid #333; transition: all 0.3s;
        }
        .status-online { color: #00ff00; border-color: #00ff00; background: rgba(0,255,0,0.1); }
        .status-offline { color: #ff0000; border-color: #ff0000; background: rgba(255,0,0,0.1); }

        .btn { 
            background: #222; border: 1px solid #00ff00; color: #fff; padding: 10px 20px; 
            cursor: pointer; font-family: inherit; font-weight: bold; margin: 5px; width: 100%; max-width: 300px;
            transition: all 0.2s;
        }
        .btn:hover { background: #00ff00; color: #000; }
        .btn:disabled { border-color: #555; color: #555; background: #111; cursor: not-allowed; }
        
        .btn-danger { border-color: #ff4444; color: #ff4444; margin-top: 10px; }
        .btn-danger:hover { background: #ff4444; color: #fff; }

        input { background: #111; border: 1px solid #555; color: white; padding: 10px; text-align: center; font-family: inherit; }

        .view { display: none; width: 95%; max-width: 100%; flex-direction: column; align-items: center; padding: 10px; box-sizing: border-box; }
        .view.active { display: flex; }

        .lobby-card { 
            background: #111; border: 1px solid #444; padding: 15px; margin: 10px auto; width: 100%; max-width: 800px;
            display: flex; justify-content: space-between; align-items: center; 
        }

        .player-list { width: 100%; display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin: 20px 0; }
        .player-chip { 
            background: #222; border: 1px solid #444; padding: 10px; text-align: center; border-radius: 5px; 
            display: flex; flex-direction: column; align-items: center;
        }
        .player-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #00ff00; margin-bottom: 5px; }

        /* GAME GRID */
        #race-container {
            width: 100%; overflow-x: auto; padding-bottom: 20px; margin-top: 20px;
            display: flex; justify-content: center;
        }
        .race-grid {
            display: grid;
            grid-template-columns: 70px repeat(7, 1fr) 70px; 
            grid-template-rows: 50px repeat(4, 50px); 
            gap: 5px; 
            min-width: 800px; 
            width: 100%; 
            border: 2px solid #333; padding: 10px; background: #111;
        }

        .cell { border: 1px dashed #333; display: flex; justify-content: center; align-items: center; position: relative; }
        .cell-penalty { border-bottom: 2px solid #ff0000; }
        .cell-goal { background: repeating-linear-gradient(45deg, #222, #222 10px, #000 10px, #000 20px); border-left: 2px solid #fff; }

        .card {
            width: 56px; height: 40px; 
            background: white; border-radius: 4px; color: black; 
            font-weight: bold; display: flex; justify-content: center; align-items: center; font-size: 1.2rem;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5); user-select: none;
        }
        .card-back {
            background: repeating-linear-gradient(45deg, #b71c1c, #b71c1c 5px, #d32f2f 5px, #d32f2f 10px);
            border: 2px solid #fff;
        }
        .suit-red { color: #d32f2f; }
        .suit-black { color: #000; }

        .bet-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        
        .bet-option { 
            background: #e0e0e0; border: 2px solid #999; 
            padding: 10px; cursor: pointer; text-align: center; font-size: 2rem; border-radius: 5px; 
            transition: transform 0.2s;
            box-shadow: 0 0 5px rgba(255,255,255,0.1);
        }
        .bet-option.suit-red { color: #d32f2f; border-color: #d32f2f; }
        .bet-option.suit-black { color: #000; border-color: #555; }

        .bet-option:hover { transform: scale(1.1); background: #fff; }
        .bet-option.selected { 
            background: #fff; 
            box-shadow: 0 0 15px currentColor; 
            transform: scale(1.1); 
            border-width: 3px;
        }

        #action-area {
            position: sticky; bottom: 0; background: rgba(0,0,0,0.9); width: 100%; padding: 15px;
            display: flex; flex-direction: column; align-items: center; border-top: 1px solid #333; z-index: 100;
        }
        .last-card-anim {
            width: 60px; height: 84px; font-size: 1.5rem; margin-bottom: 10px; border: 4px solid #fff;
            animation: popIn 0.3s ease-out;
        }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

    </style>
</head>
<body>

    <button onclick="window.location.href='lobby.html'" class="btn-home">üè† HOME</button>
    <div id="status-display" class="status-online">ONLINE üü¢</div>

    <div id="view-start" class="view active">
        <h1>üêé MULTIPLAYER DERBY</h1>
        <p>Erstelle eine Runde oder tritt bei.</p>
        <div style="width: 100%; max-width: 800px; margin: 20px 0;">
            <h3>Offene Lobbys</h3>
            <div id="lobby-list">Lade...</div>
        </div>
        <button class="btn" onclick="createNewLobby()">NEUE LOBBY ERSTELLEN</button>
    </div>

    <div id="view-lobby" class="view">
        <h2 id="lobby-title">Lobby</h2>
        <p>Warte auf Spieler... (<span id="player-count">0</span>)</p>
        <div class="player-list" id="lobby-players"></div>

        <div id="betting-controls" style="width: 100%; max-width: 500px; text-align: center;">
            <h3>DEIN EINSATZ</h3>
            <div class="bet-grid">
                <div class="bet-option suit-red" onclick="selectBet('‚ô¶', this)">‚ô¶</div>
                <div class="bet-option suit-red" onclick="selectBet('‚ô•', this)">‚ô•</div>
                <div class="bet-option suit-black" onclick="selectBet('‚ô†', this)">‚ô†</div>
                <div class="bet-option suit-black" onclick="selectBet('‚ô£', this)">‚ô£</div>
            </div>
            <input type="number" id="bet-amount" placeholder="Coins" value="1" min="1" max="1000">
            <button class="btn" id="btn-lock-bet" onclick="lockInBet()" style="margin-top: 15px;">WETTE PLATZIEREN</button>
        </div>

        <div id="host-controls" style="margin-top: 30px; border-top: 1px solid #333; padding-top: 20px; width: 100%; display: none;">
            <p class="highlight">üëë DU BIST DER HOST</p>
            <p id="host-status-msg" style="font-size: 0.9rem; color: #aaa;">Warte auf Eins√§tze...</p>
            <button class="btn" id="btn-start-game" onclick="hostStartGame()" disabled>RENNEN STARTEN</button>
            <button class="btn btn-danger" onclick="deleteLobby()">LOBBY AUFL√ñSEN</button>
        </div>
    </div>

    <div id="view-race" class="view">
        <div style="display: flex; justify-content: space-between; width: 100%; max-width: 1000px;">
            <span>üèÅ ZIEL: 8 Felder</span>
            <span id="race-status">Rennen l√§uft...</span>
        </div>
        <div id="race-container">
            <div id="grid-target" class="race-grid"></div>
        </div>
        <div id="action-area">
            <div id="drawn-card-display"></div>
            <div id="host-game-controls" style="display: none; width: 100%;">
                <button class="btn" onclick="hostDrawCard()" style="width: 100%; font-size: 1.2rem; padding: 15px;">KARTE ZIEHEN üÉè</button>
            </div>
            <div id="client-wait-msg" style="color: #888;">Warte auf Host...</div>
        </div>
    </div>

    <div id="view-result" class="view">
        <h1>ERGEBNIS</h1>
        <div id="result-list" style="width: 100%; max-width: 800px;"></div>
        <button class="btn" onclick="window.location.href='lobby.html'" style="margin-top: 20px;">ZUR√úCK ZUR LOBBY</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, onSnapshot, updateDoc, arrayUnion, query, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyASbziojAan2xJ3EoJ0RDPa9jh1Z-5UGX0",
            authDomain: "mba-arcade.firebaseapp.com",
            projectId: "mba-arcade",
            storageBucket: "mba-arcade.firebasestorage.app",
            messagingSenderId: "497628563783",
            appId: "1:497628563783:web:a6a0a272fb97b60bbf6462"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        let currentLobbyId = null;
        let isHost = false;
        let myBetSuit = null;
        let playerName = "Gast";

        function updateOnlineStatus() {
            const statusEl = document.getElementById('status-display');
            if (navigator.onLine) { statusEl.innerText = "ONLINE üü¢"; statusEl.className = "status-online"; } 
            else { statusEl.innerText = "OFFLINE üî¥"; statusEl.className = "status-offline"; }
        }
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                playerName = user.email.replace("@mba-arcade.com", "");
                loadLobbies();
            } else {
                window.location.href = "index.html";
            }
        });

        // --- LOBBY LOGIC ---
        function loadLobbies() {
            // WICHTIG: Hier pr√ºfen wir auf "status", da das im Code nun einheitlich ist
            const q = query(collection(db, "lobbies"), where("status", "==", "waiting"));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('lobby-list');
                list.innerHTML = "";
                if(snapshot.empty) list.innerHTML = "<p style='color:#888'>Keine offenen Lobbys.</p>";
                snapshot.forEach(doc => {
                    const data = doc.data();
                    list.innerHTML += `
                        <div class="lobby-card">
                            <div><strong>Host: ${data.hostName}</strong><br><small>Spieler: ${data.players ? data.players.length : 0}</small></div>
                            <button class="btn" style="width: auto;" onclick="joinLobby('${doc.id}')">BEITRETEN</button>
                        </div>
                    `;
                });
            });
        }

        window.createNewLobby = async function() {
            const avatar = localStorage.getItem('mba_avatar') || '100.jpg';
            const lobbyData = {
                hostId: currentUser.uid,
                hostName: playerName,
                status: "waiting", // Einheitlich: "status"
                createdAt: new Date(),
                // Initial player list
                players: [{ uid: currentUser.uid, name: playerName, avatar: avatar, betAmount: 0, betSuit: null, ready: false }],
                gameState: null
            };
            const docRef = await addDoc(collection(db, "lobbies"), lobbyData);
            joinLobby(docRef.id);
        }

        window.joinLobby = async function(lobbyId) {
            currentLobbyId = lobbyId;
            document.getElementById('view-start').classList.remove('active');
            document.getElementById('view-lobby').classList.add('active');

            onSnapshot(doc(db, "lobbies", lobbyId), (docSnap) => {
                if(!docSnap.exists()) { alert("Lobby wurde aufgel√∂st."); window.location.reload(); return; }
                const data = docSnap.data();
                renderLobbyRoom(data);
            });
        }

        window.deleteLobby = async function() {
            if(confirm("M√∂chtest du diese Lobby wirklich l√∂schen?")) {
                await deleteDoc(doc(db, "lobbies", currentLobbyId));
            }
        }

        function renderLobbyRoom(data) {
            // Check if I am in the player list, if not add me
            const me = data.players.find(p => p.name === playerName); // Identify by Name for safety
            if(!me) {
                const avatar = localStorage.getItem('mba_avatar') || '100.jpg';
                // Add myself using arrayUnion to avoid overwriting others
                updateDoc(doc(db, "lobbies", currentLobbyId), {
                    players: arrayUnion({ uid: currentUser.uid, name: playerName, avatar: avatar, betAmount: 0, betSuit: null, ready: false })
                });
                return; // Wait for next update
            }

            isHost = (data.hostId === currentUser.uid);
            
            const list = document.getElementById('lobby-players');
            list.innerHTML = "";
            let readyCount = 0;

            data.players.forEach(p => {
                if(p.ready) readyCount++;
                const status = p.ready ? `<span style="color:#00ff00">Bereit (${p.betAmount}üí∞ auf ${p.betSuit})</span>` : `<span style="color:#888">Wettet...</span>`;
                list.innerHTML += `
                    <div class="player-chip">
                        <img src="${p.avatar}" class="player-avatar">
                        <strong>${p.name}</strong>
                        <small>${status}</small>
                    </div>
                `;
            });

            document.getElementById('player-count').innerText = data.players.length;

            // Host Controls
            if(isHost) {
                document.getElementById('host-controls').style.display = 'block';
                const startBtn = document.getElementById('btn-start-game');
                const msg = document.getElementById('host-status-msg');
                // Allow start only if everyone is ready
                const allReady = (data.players.length > 0 && readyCount === data.players.length);
                
                startBtn.disabled = !allReady;
                msg.innerText = allReady ? "Alle bereit!" : `Warte: ${readyCount}/${data.players.length} bereit...`;
                msg.style.color = allReady ? "#00ff00" : "#aaa";
            }

            // Hide betting if I am ready
            if(me.ready) document.getElementById('betting-controls').style.display = 'none';

            // Game State Transitions
            if(data.status === 'racing') startGameClient(data);
            if(data.status === 'finished') showResults(data);
        }

        // --- BETTING LOGIC ---
        window.selectBet = function(suit, element) {
            myBetSuit = suit;
            // Visual feedback
            document.querySelectorAll('.bet-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
        }

        window.lockInBet = async function() {
            const amount = parseInt(document.getElementById('bet-amount').value);
            if(!myBetSuit || amount <= 0) { alert("Bitte Wette w√§hlen!"); return; }

            // Safe update: Read current data, modify my entry, write back
            const lobbyRef = doc(db, "lobbies", currentLobbyId);
            const snap = await getDocs(query(collection(db, "lobbies"), where("__name__", "==", currentLobbyId)));
            const data = snap.docs[0].data();
            
            // Rebuild player list with my new status
            const newPlayers = data.players.map(p => {
                if(p.name === playerName) return { ...p, betAmount: amount, betSuit: myBetSuit, ready: true };
                return p;
            });
            await updateDoc(lobbyRef, { players: newPlayers });
        }

        // --- GAME LOGIC ---
        window.hostStartGame = async function() {
            const deck = createDeck();
            const penaltyCards = deck.splice(0, 7); 
            const positions = { '‚ô¶': 0, '‚ô•': 0, '‚ô†': 0, '‚ô£': 0 };
            
            const gameState = {
                deck: deck, 
                penaltyCards: penaltyCards,
                penaltyRevealed: [false, false, false, false, false, false, false],
                positions: positions,
                finishedOrder: [], 
                lastDrawnCard: null
            };

            await updateDoc(doc(db, "lobbies", currentLobbyId), {
                status: 'racing', // Set status to racing
                gameState: gameState
            });
        }

        window.hostDrawCard = async function() {
            const snap = await getDocs(query(collection(db, "lobbies"), where("__name__", "==", currentLobbyId)));
            const data = snap.docs[0].data();
            const gs = data.gameState;

            if(gs.deck.length === 0) gs.deck = createDeck();

            const card = gs.deck.pop();
            gs.lastDrawnCard = card;

            // Movement Logic
            if(!gs.finishedOrder.includes(card.suit)) {
                gs.positions[card.suit]++;
            }

            // Finish check (Goal is 8 steps)
            if(gs.positions[card.suit] >= 8 && !gs.finishedOrder.includes(card.suit)) {
                gs.finishedOrder.push(card.suit);
                gs.positions[card.suit] = 8; 
            }

            // Penalty Logic
            const minPos = Math.min(gs.positions['‚ô¶'], gs.positions['‚ô•'], gs.positions['‚ô†'], gs.positions['‚ô£']);
            for(let i=0; i<7; i++) {
                if(minPos >= (i+1) && !gs.penaltyRevealed[i]) {
                    gs.penaltyRevealed[i] = true;
                    const pCard = gs.penaltyCards[i];
                    if(!gs.finishedOrder.includes(pCard.suit)) {
                        gs.positions[pCard.suit]--;
                    }
                }
            }

            // Game Over Check (When 3 finished, we know the 4th is last)
            if(gs.finishedOrder.length === 3) {
                const allSuits = ['‚ô¶', '‚ô•', '‚ô†', '‚ô£'];
                const loser = allSuits.find(s => !gs.finishedOrder.includes(s));
                gs.finishedOrder.push(loser);
                calculateResults(data.players, gs.finishedOrder); 
                return; 
            }

            await updateDoc(doc(db, "lobbies", currentLobbyId), { gameState: gs });
        }

        function startGameClient(data) {
            document.getElementById('view-lobby').classList.remove('active');
            document.getElementById('view-race').classList.add('active');

            if(isHost) {
                document.getElementById('host-game-controls').style.display = 'block';
                document.getElementById('client-wait-msg').style.display = 'none';
            }
            renderGrid(data.gameState);
            renderLastCard(data.gameState.lastDrawnCard);
        }

        function renderGrid(gs) {
            const container = document.getElementById('grid-target');
            container.innerHTML = "";
            
            // Penalty Row
            container.innerHTML += `<div class="cell"></div>`;
            for(let i=0; i<7; i++) {
                let content = `<div class="card card-back"></div>`;
                if(gs.penaltyRevealed[i]) {
                    const c = gs.penaltyCards[i];
                    const color = (c.suit === '‚ô•' || c.suit === '‚ô¶') ? 'suit-red' : 'suit-black';
                    content = `<div class="card ${color}">${c.suit}${c.value}</div>`;
                }
                container.innerHTML += `<div class="cell cell-penalty">${content}</div>`;
            }
            container.innerHTML += `<div class="cell"></div>`;

            // Horse Rows
            const suits = ['‚ô¶', '‚ô•', '‚ô†', '‚ô£'];
            suits.forEach(suit => {
                const pos = gs.positions[suit];
                const color = (suit === '‚ô•' || suit === '‚ô¶') ? 'suit-red' : 'suit-black';
                for(let i=0; i<=8; i++) {
                    let cls = i===8 ? "cell cell-goal" : "cell";
                    // Render horse as a card ace
                    let content = (pos === i) ? `<div class="card ${color}" style="transform:scale(0.9); border: 2px solid gold;">${suit}</div>` : "";
                    container.innerHTML += `<div class="${cls}">${content}</div>`;
                }
            });
        }

        function renderLastCard(card) {
            const div = document.getElementById('drawn-card-display');
            if(!card) { div.innerHTML = ""; return; }
            const color = (card.suit === '‚ô•' || card.suit === '‚ô¶') ? 'suit-red' : 'suit-black';
            div.innerHTML = `<div class="card last-card-anim ${color}">${card.suit}${card.value}</div><div style="font-weight:bold; margin-top:5px;">${card.suit} zieht!</div>`;
        }

        async function calculateResults(players, finishedOrder) {
            const updatedPlayers = players.map(p => {
                const rank = finishedOrder.indexOf(p.betSuit); 
                let profit = 0, txt = "";
                
                if(rank === 0) { profit = p.betAmount * 2; txt = "SUPER (x2)"; }
                else if(rank === 1) { profit = p.betAmount * 1; txt = "GUT (x1)"; }
                else if(rank === 2) { profit = p.betAmount * -1; txt = "VERLOREN (-1x)"; }
                else if(rank === 3) { profit = p.betAmount * -2; txt = "STRAFE (-2x)"; }
                
                return { ...p, payout: profit, resultText: txt };
            });
            await updateDoc(doc(db, "lobbies", currentLobbyId), { players: updatedPlayers, status: 'finished' });
        }

        function showResults(data) {
            document.getElementById('view-race').classList.remove('active');
            document.getElementById('view-result').classList.add('active');
            const list = document.getElementById('result-list');
            const o = data.gameState.finishedOrder;
            
            let html = `<div style="margin-bottom:20px; padding:10px; border:1px solid #444; border-radius:5px;">
                <h3>Einlauf</h3>
                <div style="display:flex; justify-content:space-around; font-size:1.5rem;">
                    <span>ü•á${o[0]}</span><span>ü•à${o[1]}</span><span>ü•â${o[2]}</span><span>üíÄ${o[3]}</span>
                </div></div><h3>Bilanz</h3>`;
            
            data.players.forEach(p => {
                let col = p.payout > 0 ? "#00ff00" : (p.payout < 0 ? "#ff0000" : "#fff");
                html += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #333;">
                    <span>${p.name} (${p.betSuit})</span>
                    <div style="text-align:right;"><div style="font-weight:bold; color:${col}">${p.payout>0?'+':''}${p.payout}</div><small>${p.resultText}</small></div>
                </div>`;
            });
            list.innerHTML = html;
        }

        function createDeck() {
            const suits = ['‚ô¶', '‚ô•', '‚ô†', '‚ô£'];
            const values = ['7', '8', '9', '10', 'B', 'D', 'K', 'A']; 
            let d = [];
            for (let s of suits) for (let v of values) d.push({ suit: s, value: v });
            for (let i = d.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [d[i], d[j]] = [d[j], d[i]];
            }
            return d;
        }
        
        // Expose functions to window
        window.joinLobby = joinLobby;
        window.createNewLobby = createNewLobby;
        window.selectBet = selectBet;
        window.lockInBet = lockInBet;
        window.hostStartGame = hostStartGame;
        window.hostDrawCard = hostDrawCard;
        window.deleteLobby = deleteLobby;
    </script>
</body>
</html>