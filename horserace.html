<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MBA Derby Multiplayer</title>
    <style>
        body { 
            background-color: #050505; color: #fff; font-family: 'Courier New', monospace; 
            margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        }

        /* --- UI COMPONENTS --- */
        h1 { color: #00ff00; text-shadow: 0 0 10px rgba(0,255,0,0.5); margin: 10px 0; font-size: 1.5rem; text-align: center;}
        .highlight { color: #ffff00; font-weight: bold; }
        
        /* Neuer Home Button Style (wie in Lobby) */
        .btn-home {
            background: #000; color: #00ff00; border: 1px solid #00ff00; 
            padding: 8px 12px; border-radius: 5px; cursor: pointer;
            font-family: 'Courier New', monospace; font-weight: bold;
            margin-bottom: 20px; align-self: flex-start;
            font-size: 1.2rem; text-decoration: none; display: inline-block;
        }

        .btn { 
            background: #222; border: 1px solid #00ff00; color: #fff; padding: 10px 20px; 
            cursor: pointer; font-family: inherit; font-weight: bold; margin: 5px; width: 100%; max-width: 300px;
            transition: all 0.2s;
        }
        .btn:hover { background: #00ff00; color: #000; }
        .btn:disabled { border-color: #555; color: #555; background: #111; cursor: not-allowed; }
        
        input { background: #111; border: 1px solid #555; color: white; padding: 10px; text-align: center; font-family: inherit; }

        /* --- VIEWS --- */
        .view { display: none; width: 100%; max-width: 1000px; flex-direction: column; align-items: center; padding: 10px; box-sizing: border-box; }
        .view.active { display: flex; }

        /* --- LOBBY LISTE --- */
        .lobby-card { 
            background: #1a1a1a; border: 1px solid #444; padding: 15px; margin: 10px 0; width: 100%; 
            display: flex; justify-content: space-between; align-items: center; 
        }

        /* --- WAITING ROOM --- */
        .player-list { width: 100%; display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin: 20px 0; }
        .player-chip { 
            background: #222; border: 1px solid #444; padding: 10px; text-align: center; border-radius: 5px; 
            display: flex; flex-direction: column; align-items: center;
        }
        .player-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #00ff00; margin-bottom: 5px; }

        /* --- GAME GRID (THE RACE) --- */
        #race-container {
            width: 100%;
            overflow-x: auto; /* Scrollen auf Handy */
            padding-bottom: 20px;
            margin-top: 20px;
        }
        
        .race-grid {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr) 60px; /* Start (Asse) | 7 Felder | Ziel */
            grid-template-rows: 80px repeat(4, 60px); /* Penalty Zeile | 4 Pferde Zeilen */
            gap: 5px;
            min-width: 600px; /* Damit es nicht zu eng wird */
            border: 2px solid #333;
            padding: 10px;
            background: #111;
        }

        .cell { border: 1px dashed #333; display: flex; justify-content: center; align-items: center; position: relative; }
        .cell-penalty { border-bottom: 2px solid #ff0000; }
        .cell-goal { background: repeating-linear-gradient(45deg, #222, #222 10px, #000 10px, #000 20px); border-left: 2px solid #fff; }

        /* --- CARDS --- */
        .card {
            width: 40px; height: 56px; background: white; border-radius: 4px; color: black; 
            font-weight: bold; display: flex; justify-content: center; align-items: center; font-size: 1.2rem;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5); user-select: none;
        }
        .card-back {
            background: repeating-linear-gradient(45deg, #b71c1c, #b71c1c 5px, #d32f2f 5px, #d32f2f 10px);
            border: 2px solid #fff;
        }
        .suit-red { color: #d32f2f; }
        .suit-black { color: #000; }

        /* --- CURRENT ACTION --- */
        #action-area {
            position: sticky; bottom: 0; background: rgba(0,0,0,0.9); width: 100%; padding: 15px;
            display: flex; flex-direction: column; align-items: center; border-top: 1px solid #333; z-index: 100;
        }
        .last-card-anim {
            width: 60px; height: 84px; font-size: 1.5rem; margin-bottom: 10px; border: 4px solid #fff;
            animation: popIn 0.3s ease-out;
        }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        /* --- BETTING (NEUES DESIGN) --- */
        .bet-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        
        .bet-option { 
            /* Heller Hintergrund damit man Schwarz sieht */
            background: #e0e0e0; 
            border: 2px solid #999; 
            padding: 10px; cursor: pointer; text-align: center; font-size: 2rem; border-radius: 5px; 
            transition: transform 0.2s;
            color: #000; /* Immer schwarz als Grundfarbe */
            box-shadow: 0 0 5px rgba(255,255,255,0.1);
        }
        .bet-option:hover { transform: scale(1.1); background: #fff; }
        .bet-option.selected { 
            border-color: #00ff00; 
            background: #fff; 
            box-shadow: 0 0 15px #00ff00; 
            transform: scale(1.1); 
        }

    </style>
</head>
<body>

    <div id="view-start" class="view active">
        <button onclick="window.location.href='lobby.html'" class="btn-home">üè†</button>
        
        <h1>üêé MULTIPLAYER DERBY</h1>
        <p>Erstelle eine Runde oder tritt bei.</p>
        
        <div style="width: 100%; margin: 20px 0;">
            <h3>Offene Lobbys</h3>
            <div id="lobby-list">Lade...</div>
        </div>

        <button class="btn" onclick="createNewLobby()">NEUE LOBBY ERSTELLEN</button>
    </div>

    <div id="view-lobby" class="view">
        <h2 id="lobby-title">Lobby</h2>
        <p>Warte auf Spieler... (<span id="player-count">0</span>)</p>

        <div class="player-list" id="lobby-players"></div>

        <div id="betting-controls" style="width: 100%; max-width: 500px; text-align: center;">
            <h3>DEIN EINSATZ</h3>
            <div class="bet-grid">
                <div class="bet-option suit-red" onclick="selectBet('‚ô¶')">‚ô¶</div>
                <div class="bet-option suit-red" onclick="selectBet('‚ô•')">‚ô•</div>
                <div class="bet-option suit-black" onclick="selectBet('‚ô†')">‚ô†</div>
                <div class="bet-option suit-black" onclick="selectBet('‚ô£')">‚ô£</div>
            </div>
            <input type="number" id="bet-amount" placeholder="Coins" value="100" min="10" max="1000">
            <div style="margin-top: 10px; font-size: 0.8rem; color: #888;">Max. 1000 Coins</div>
            <button class="btn" id="btn-lock-bet" onclick="lockInBet()" style="margin-top: 15px;">WETTE PLATZIEREN</button>
        </div>

        <div id="host-controls" style="margin-top: 30px; border-top: 1px solid #333; padding-top: 20px; width: 100%; display: none;">
            <p class="highlight">üëë DU BIST DER HOST</p>
            <p id="host-status-msg" style="font-size: 0.9rem; color: #aaa;">Warte auf Eins√§tze...</p>
            <button class="btn" id="btn-start-game" onclick="hostStartGame()" disabled>RENNEN STARTEN</button>
        </div>
    </div>

    <div id="view-race" class="view">
        <div style="display: flex; justify-content: space-between; width: 100%;">
            <span>üèÅ ZIEL: 8 Felder</span>
            <span id="race-status">Rennen l√§uft...</span>
        </div>

        <div id="race-container">
            <div id="grid-target" class="race-grid"></div>
        </div>

        <div id="action-area">
            <div id="drawn-card-display"></div>
            
            <div id="host-game-controls" style="display: none; width: 100%;">
                <button class="btn" onclick="hostDrawCard()" style="width: 100%; font-size: 1.2rem; padding: 15px;">KARTE ZIEHEN üÉè</button>
            </div>
            <div id="client-wait-msg" style="color: #888;">Warte auf Host...</div>
        </div>
    </div>

    <div id="view-result" class="view">
        <h1>ERGEBNIS</h1>
        <div id="result-list" style="width: 100%; max-width: 600px;"></div>
        <button class="btn" onclick="window.location.href='lobby.html'" style="margin-top: 20px;">ZUR√úCK ZUR LOBBY</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, onSnapshot, updateDoc, arrayUnion, query, where, getDocs, setDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- HIER DEINE FIREBASE CONFIG EINF√úGEN ---
        const firebaseConfig = {
            apiKey: "AIzaSyASbziojAan2xJ3EoJ0RDPa9jh1Z-5UGX0",
            authDomain: "mba-arcade.firebaseapp.com",
            projectId: "mba-arcade",
            storageBucket: "mba-arcade.firebasestorage.app",
            messagingSenderId: "497628563783",
            appId: "1:497628563783:web:a6a0a272fb97b60bbf6462"
             // ... deine Config ...
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- GLOBAL STATE ---
        let currentUser = null;
        let currentLobbyId = null;
        let lobbyUnsubscribe = null;
        let isHost = false;
        let myBetSuit = null;

        // --- SETUP ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                loadLobbies();
            } else {
                window.location.href = "index.html";
            }
        });

        // --- LOBBY LISTE ---
        function loadLobbies() {
            const q = query(collection(db, "lobbies"), where("state", "==", "waiting"));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('lobby-list');
                list.innerHTML = "";
                if(snapshot.empty) list.innerHTML = "<p style='color:#888'>Keine offenen Lobbys.</p>";
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const playerCount = data.players ? data.players.length : 0;
                    list.innerHTML += `
                        <div class="lobby-card">
                            <div>
                                <strong>Host: ${data.hostName}</strong><br>
                                <small>Spieler: ${playerCount}</small>
                            </div>
                            <button class="btn" style="width: auto;" onclick="joinLobby('${doc.id}')">BEITRETEN</button>
                        </div>
                    `;
                });
            });
        }

        window.createNewLobby = async function() {
            const playerName = currentUser.email.replace("@mba-arcade.com", "");
            const avatar = localStorage.getItem('mba_avatar') || '100.jpg';

            const lobbyData = {
                hostId: currentUser.uid,
                hostName: playerName,
                state: "waiting",
                createdAt: new Date(),
                players: [{
                    uid: currentUser.uid,
                    name: playerName,
                    avatar: avatar,
                    betAmount: 0,
                    betSuit: null,
                    ready: false
                }],
                gameState: null
            };

            const docRef = await addDoc(collection(db, "lobbies"), lobbyData);
            joinLobby(docRef.id);
        }

        window.joinLobby = async function(lobbyId) {
            currentLobbyId = lobbyId;
            const playerName = currentUser.email.replace("@mba-arcade.com", "");
            
            // UI Wechsel
            document.getElementById('view-start').classList.remove('active');
            document.getElementById('view-lobby').classList.add('active');

            // Listener starten
            const lobbyRef = doc(db, "lobbies", lobbyId);
            lobbyUnsubscribe = onSnapshot(lobbyRef, (docSnap) => {
                if(!docSnap.exists()) { alert("Lobby geschlossen"); window.location.reload(); return; }
                const data = docSnap.data();
                renderLobbyRoom(data);
            });
        }

        function renderLobbyRoom(data) {
            // Check ob ich schon in der Spielerliste bin
            const me = data.players.find(p => p.uid === currentUser.uid);
            
            if(!me) {
                // Wenn nicht, f√ºge mich hinzu
                const playerName = currentUser.email.replace("@mba-arcade.com", "");
                const avatar = localStorage.getItem('mba_avatar') || '100.jpg';
                const newPlayer = { uid: currentUser.uid, name: playerName, avatar: avatar, betAmount: 0, betSuit: null, ready: false };
                updateDoc(doc(db, "lobbies", currentLobbyId), {
                    players: arrayUnion(newPlayer)
                });
                return; // Warte auf n√§chsten Snapshot
            }

            isHost = (data.hostId === currentUser.uid);
            
            // Player Liste rendern
            const list = document.getElementById('lobby-players');
            list.innerHTML = "";
            let readyCount = 0;

            data.players.forEach(p => {
                if(p.ready) readyCount++;
                const status = p.ready ? `<span style="color:#00ff00">Bereit (${p.betAmount} auf ${p.betSuit})</span>` : `<span style="color:#888">Wettet...</span>`;
                
                list.innerHTML += `
                    <div class="player-chip">
                        <img src="${p.avatar}" class="player-avatar">
                        <strong>${p.name}</strong>
                        <small>${status}</small>
                    </div>
                `;
            });

            document.getElementById('player-count').innerText = data.players.length;

            // Host Controls
            if(isHost) {
                document.getElementById('host-controls').style.display = 'block';
                const startBtn = document.getElementById('btn-start-game');
                const statusMsg = document.getElementById('host-status-msg');
                
                // START BEDINGUNG:
                // Alle anwesenden Spieler m√ºssen 'ready' sein. 
                // Es ist egal ob es 2, 3 oder 4 Spieler sind.
                const allPlayersReady = (data.players.length > 0) && (readyCount === data.players.length);
                
                startBtn.disabled = !allPlayersReady;
                
                if(!allPlayersReady) {
                    statusMsg.innerText = `Warte auf Eins√§tze: ${readyCount} / ${data.players.length} bereit...`;
                    statusMsg.style.color = "#aaa";
                } else {
                    statusMsg.innerText = "Alle bereit! Start m√∂glich.";
                    statusMsg.style.color = "#00ff00";
                }
            }

            // Betting UI verstecken wenn ich schon ready bin
            if(me.ready) {
                document.getElementById('betting-controls').style.display = 'none';
            }

            // Spielstart Check
            if(data.state === 'racing') {
                startGameClient(data);
            }
            if(data.state === 'finished') {
                showResults(data);
            }
        }

        // --- BETTING LOGIC ---
        window.selectBet = function(suit) {
            myBetSuit = suit;
            document.querySelectorAll('.bet-option').forEach(el => el.classList.remove('selected'));
            const options = document.querySelectorAll('.bet-option');
            options.forEach(opt => { if(opt.innerText.includes(suit)) opt.classList.add('selected'); });
        }

        window.lockInBet = async function() {
            const amount = parseInt(document.getElementById('bet-amount').value);
            if(!myBetSuit || amount <= 0 || amount > 1000) { alert("Bitte Pferd und Einsatz w√§hlen!"); return; }

            // Umweg √ºber Snapshot Update (Transaction w√§re sauberer, aber dies reicht f√ºr Arcade)
            const lobbyDoc = await getDocs(query(collection(db, "lobbies"), where("__name__", "==", currentLobbyId)));
            const data = lobbyDoc.docs[0].data();
            
            const newPlayers = data.players.map(p => {
                if(p.uid === currentUser.uid) {
                    return { ...p, betAmount: amount, betSuit: myBetSuit, ready: true };
                }
                return p;
            });
            
            await updateDoc(doc(db, "lobbies", currentLobbyId), { players: newPlayers });
        }

        // --- HOST GAME LOGIC ---
        window.hostStartGame = async function() {
            const deck = createDeck();
            const penaltyCards = deck.splice(0, 7); 
            const positions = { '‚ô¶': 0, '‚ô•': 0, '‚ô†': 0, '‚ô£': 0 };
            
            const gameState = {
                deck: deck, 
                penaltyCards: penaltyCards,
                penaltyRevealed: [false, false, false, false, false, false, false],
                positions: positions,
                finishedOrder: [], 
                lastDrawnCard: null
            };

            await updateDoc(doc(db, "lobbies", currentLobbyId), {
                state: 'racing',
                gameState: gameState
            });
        }

        window.hostDrawCard = async function() {
            const snap = await getDocs(query(collection(db, "lobbies"), where("__name__", "==", currentLobbyId)));
            const data = snap.docs[0].data();
            const gs = data.gameState;

            if(gs.deck.length === 0) return; 

            const card = gs.deck.pop();
            gs.lastDrawnCard = card;

            // 1. BEWEGUNG
            if(!gs.finishedOrder.includes(card.suit)) {
                gs.positions[card.suit]++;
            }

            // 2. CHECK FINISH (Grid Index 8 = Ziel)
            if(gs.positions[card.suit] >= 8 && !gs.finishedOrder.includes(card.suit)) {
                gs.finishedOrder.push(card.suit);
                gs.positions[card.suit] = 8; 
            }

            // 3. PENALTY CHECK
            const minPos = Math.min(gs.positions['‚ô¶'], gs.positions['‚ô•'], gs.positions['‚ô†'], gs.positions['‚ô£']);
            
            for(let i=0; i<7; i++) {
                // i ist Index im PenaltyArray. Die Grid-Spalte ist i+1.
                // Wenn das letzte Pferd (minPos) √ºber i+1 ist:
                if(minPos > (i+1) && !gs.penaltyRevealed[i]) {
                    gs.penaltyRevealed[i] = true;
                    const pCard = gs.penaltyCards[i];
                    
                    // Ass gleicher Farbe muss 1 zur√ºck, falls nicht finished
                    if(!gs.finishedOrder.includes(pCard.suit)) {
                        gs.positions[pCard.suit]--;
                    } 
                    // Variante: Auch aus dem Ziel zur√ºck? Du sagtest "nein" wenn Spiel vorbei, 
                    // aber solange Spiel l√§uft, kann man theoretisch rausfliegen? 
                    // Wir lassen finished Pferde sicher im Stall f√ºr weniger Frust.
                }
            }

            // 4. CHECK GAME OVER
            let newState = 'racing';
            if(gs.finishedOrder.length === 4) {
                newState = 'finished';
                calculateResults(data.players, gs.finishedOrder); 
                return; 
            }

            await updateDoc(doc(db, "lobbies", currentLobbyId), {
                gameState: gs,
                state: newState
            });
        }

        // --- GAME CLIENT LOGIC ---
        function startGameClient(data) {
            document.getElementById('view-lobby').classList.remove('active');
            document.getElementById('view-race').classList.add('active');

            if(isHost) {
                document.getElementById('host-game-controls').style.display = 'block';
                document.getElementById('client-wait-msg').style.display = 'none';
            }

            renderGrid(data.gameState);
            renderLastCard(data.gameState.lastDrawnCard);
        }

        function renderGrid(gs) {
            const container = document.getElementById('grid-target');
            container.innerHTML = "";

            // ZEILE 0: Penalty Cards
            container.innerHTML += `<div class="cell"></div>`;
            for(let i=0; i<7; i++) {
                let content = "";
                if(gs.penaltyRevealed[i]) {
                    const c = gs.penaltyCards[i];
                    const color = (c.suit === '‚ô•' || c.suit === '‚ô¶') ? 'suit-red' : 'suit-black';
                    content = `<div class="card ${color}">${c.suit}${c.value}</div>`;
                } else {
                    content = `<div class="card card-back"></div>`;
                }
                container.innerHTML += `<div class="cell cell-penalty">${content}</div>`;
            }
            container.innerHTML += `<div class="cell"></div>`;

            // ZEILEN 1-4: PFERDE
            const suits = ['‚ô¶', '‚ô•', '‚ô†', '‚ô£'];
            suits.forEach(suit => {
                const pos = gs.positions[suit];
                const color = (suit === '‚ô•' || suit === '‚ô¶') ? 'suit-red' : 'suit-black';
                
                for(let i=0; i<=8; i++) {
                    let cellClass = "cell";
                    if(i === 8) cellClass += " cell-goal";
                    let content = "";
                    if(pos === i) {
                        content = `<div class="card ${color}" style="transform: scale(0.9);">${suit}A</div>`;
                    }
                    container.innerHTML += `<div class="${cellClass}">${content}</div>`;
                }
            });
        }

        function renderLastCard(card) {
            const div = document.getElementById('drawn-card-display');
            if(!card) { div.innerHTML = ""; return; }
            const color = (card.suit === '‚ô•' || card.suit === '‚ô¶') ? 'suit-red' : 'suit-black';
            div.innerHTML = `
                <div class="card last-card-anim ${color}">
                    ${card.suit}${card.value}
                </div>
                <div style="color: #fff; font-weight: bold; margin-top:5px;">${card.suit} zieht!</div>
            `;
        }

        // --- RESULTS ---
        async function calculateResults(players, finishedOrder) {
            const updatedPlayers = players.map(p => {
                const rankIndex = finishedOrder.indexOf(p.betSuit); 
                let resultText = "";
                let profit = 0;
                
                if(rankIndex === 0) { profit = p.betAmount; resultText = "GEWINN (x2)"; }
                else if(rankIndex === 1) { profit = 0; resultText = "R√ºckerstattung"; }
                else if(rankIndex === 2) { profit = -p.betAmount; resultText = "VERLOREN"; }
                else if(rankIndex === 3) { profit = -2 * p.betAmount; resultText = "TOTALSCHADEN (-2x)"; }
                
                return { ...p, payout: profit, resultText: resultText, rank: rankIndex + 1 };
            });

            await updateDoc(doc(db, "lobbies", currentLobbyId), {
                players: updatedPlayers,
                state: 'finished'
            });
        }

        function showResults(data) {
            document.getElementById('view-race').classList.remove('active');
            document.getElementById('view-result').classList.add('active');
            
            const list = document.getElementById('result-list');
            list.innerHTML = "";
            
            const order = data.gameState.finishedOrder;
            let html = `<div style="margin-bottom: 20px; padding: 10px; border: 1px solid #444; border-radius: 5px;">
                <h3>Einlauf</h3>
                <div style="display:flex; justify-content:space-around; font-size: 1.5rem;">
                    <span>ü•á ${order[0]}</span>
                    <span>ü•à ${order[1]}</span>
                    <span>ü•â ${order[2]}</span>
                    <span>üíÄ ${order[3]}</span>
                </div>
            </div>`;

            html += "<h3>Spieler Bilanz</h3>";
            data.players.forEach(p => {
                let color = "#fff";
                if(p.payout > 0) color = "#00ff00";
                if(p.payout < 0) color = "#ff0000";
                
                const isMe = (p.uid === currentUser.uid);
                const style = isMe ? "border: 2px solid #fff; background: #222;" : "border-bottom: 1px solid #333;";
                
                html += `
                    <div style="display: flex; justify-content: space-between; padding: 10px; align-items: center; ${style}">
                        <div style="display:flex; align-items:center;">
                            <img src="${p.avatar}" style="width:30px; height:30px; border-radius:50%; margin-right:10px;">
                            <span>${p.name} (setzte ${p.betSuit})</span>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-weight:bold; color: ${color}">${p.payout > 0 ? '+' : ''}${p.payout} Coins</div>
                            <small>${p.resultText}</small>
                        </div>
                    </div>
                `;
            });
            list.innerHTML = html;
        }

        // --- HELPER: DECK ---
        function createDeck() {
            const suits = ['‚ô¶', '‚ô•', '‚ô†', '‚ô£'];
            const values = ['7', '8', '9', '10', 'B', 'D', 'K']; 
            let newDeck = [];
            for (let s of suits) {
                for (let v of values) {
                    newDeck.push({ suit: s, value: v });
                }
            }
            for (let i = newDeck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newDeck[i], newDeck[j]] = [newDeck[j], newDeck[i]];
            }
            return newDeck;
        }
    </script>
</body>
</html>