<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBA Snake Global</title>
    <style>
        body { 
            background-color: #000; 
            color: #fff; 
            font-family: 'Courier New', monospace; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh; 
            touch-action: manipulation; 
            position: relative; 
            overflow-x: hidden;
        }

        /* --- STATUS ANZEIGE (NEU) --- */
        #status-display {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 8px 12px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.9rem;
            z-index: 1000;
            border: 1px solid #333;
            transition: all 0.3s;
        }
        .status-online { color: #00ff00; border-color: #00ff00; background: rgba(0,255,0,0.1); box-shadow: 0 0 10px rgba(0,255,0,0.2); }
        .status-offline { color: #ff0000; border-color: #ff0000; background: rgba(255,0,0,0.1); box-shadow: 0 0 10px rgba(255,0,0,0.2); }

        /* --- LAYOUT CONTAINER --- */
        .main-layout {
            display: flex;
            flex-wrap: wrap; 
            justify-content: center;
            align-items: flex-start;
            gap: 50px;
            margin-top: 80px; 
            width: 100%;
            max-width: 1200px;
            padding: 20px;
            box-sizing: border-box;
        }

        .left-column { flex: 1; min-width: 300px; display: flex; flex-direction: column; align-items: center; }
        .right-column { width: 350px; min-width: 300px; }

        /* --- TABELLEN DESIGN --- */
        .highscore-box { border: 2px solid #333; padding: 20px; border-radius: 15px; background: #111; box-shadow: 0 0 20px rgba(0,255,0,0.1); }
        table { border-collapse: collapse; width: 100%; color: white; }
        th, td { border-bottom: 1px solid #333; padding: 10px; text-align: center; font-size: 0.9rem; }
        th { color: #00ff00; border-bottom: 2px solid #00ff00; padding-bottom: 15px; text-transform: uppercase; }
        tr:last-child td { border-bottom: none; }

        /* --- SPIEL ELEMENTE --- */
        canvas { border: 4px solid #808080; background-color: #111; max-width: 100%; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        .controls { display: grid; grid-template-columns: repeat(3, 60px); grid-template-rows: repeat(2, 60px); gap: 10px; margin-top: 20px; }
        .ctrl-btn { width: 60px; height: 60px; background: #333; border: 2px solid #808080; color: white; font-size: 1.5rem; border-radius: 10px; cursor: pointer; user-select: none; }
        .up { grid-column: 2; grid-row: 1; } .left { grid-column: 1; grid-row: 2; } .down { grid-column: 2; grid-row: 2; } .right { grid-column: 3; grid-row: 2; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .highlight { color: #00ff00; font-weight: bold; }
        
        @media (max-width: 800px) {
            .main-layout { flex-direction: column; align-items: center; }
            .right-column { width: 100%; order: 2; } 
            .left-column { width: 100%; order: 1; }
        }
    </style>
</head>
<body>

    <button onclick="window.location.href='lobby.html'" style="
        position: absolute; top: 15px; left: 15px; 
        background: #000; color: #00ff00; border: 1px solid #00ff00; 
        padding: 8px 12px; border-radius: 5px; cursor: pointer;
        font-family: 'Courier New', monospace; font-weight: bold; z-index: 1000;">
        üè† HOME
    </button>

    <div id="status-display" class="status-online">ONLINE üü¢</div>

    <div class="main-layout">
        
        <div class="left-column">
            
            <div id="start-screen" style="text-align: center; padding: 40px 0;">
                <h1 style="color: #00ff00; font-size: 3.5rem; text-shadow: 0 0 20px rgba(0,255,0,0.5); margin: 0;">MBA SNAKE</h1>
                <p style="color: #888; margin-top: -10px; letter-spacing: 2px;">GLOBAL EDITION</p>
                <h2 id="welcome-msg" style="color: white; margin-top: 40px; font-size: 1.5rem;">Lade Profil...</h2>
                <button onclick="startGame()" style="
                    margin-top: 20px; padding: 15px 40px; font-size: 1.5rem; 
                    background: #000; color: #00ff00; border: 2px solid #00ff00; 
                    cursor: pointer; font-family: 'Courier New', monospace; font-weight: bold;
                    box-shadow: 0 0 15px rgba(0,255,0,0.3); transition: all 0.2s;">
                    SPIEL STARTEN
                </button>
            </div>

            <div id="game-view" class="hidden" style="display: flex; flex-direction: column; align-items: center;">
                <div id="game-info" style="width: 100%; display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1.2rem; font-weight: bold;">
                    <span id="displayName">Spieler: ...</span>
                    <span>Score: <span id="score" class="highlight">0</span></span>
                </div>
                <canvas id="gameCanvas" width="400" height="400"></canvas>
                <div class="controls">
                    <button class="ctrl-btn up" onclick="changeDirection({keyCode: 38})">‚ñ≤</button>
                    <button class="ctrl-btn left" onclick="changeDirection({keyCode: 37})">‚óÄ</button>
                    <button class="ctrl-btn down" onclick="changeDirection({keyCode: 40})">‚ñº</button>
                    <button class="ctrl-btn right" onclick="changeDirection({keyCode: 39})">‚ñ∂</button>
                </div>
            </div>
        </div>

        <div class="right-column">
            <div class="highscore-box">
                <h2 style="color:#00ff00; text-align: center; margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 10px;">üèÜ TOP 10</h2>
                <table>
                    <thead><tr><th style="width: 15%">#</th><th>Name</th><th>Score</th></tr></thead>
                    <tbody id="leaderboard-body"><tr><td colspan="3">Lade Daten...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- HIER WIEDER DEINE FIREBASE CONFIG EINF√úGEN! ---
        const firebaseConfig = {
            apiKey: "AIzaSyASbziojAan2xJ3EoJ0RDPa9jh1Z-5UGX0",
            authDomain: "mba-arcade.firebaseapp.com",
            projectId: "mba-arcade",
            storageBucket: "mba-arcade.firebasestorage.app",
            messagingSenderId: "497628563783",
            appId: "1:497628563783:web:a6a0a272fb97b60bbf6462"
             // ... DEIN CONFIG BLOCK ...
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let playerName = "Gast";

        // --- ONLINE/OFFLINE ERKENNUNG (NEU) ---
        function updateOnlineStatus() {
            const statusEl = document.getElementById('status-display');
            if (navigator.onLine) {
                statusEl.innerText = "ONLINE üü¢";
                statusEl.className = "status-online";
                loadLeaderboard(); // Wenn wir wieder online sind, Highscore neu laden!
            } else {
                statusEl.innerText = "OFFLINE üî¥";
                statusEl.className = "status-offline";
            }
        }
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus(); // Beim Start pr√ºfen

        // --- LOGIN & LADEN ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                playerName = user.email.replace("@mba-arcade.com", "");
                document.getElementById('welcome-msg').innerText = "Hallo " + playerName + "!";
                document.getElementById('displayName').innerText = "Spieler: " + playerName;
                loadLeaderboard();
            } else {
                window.location.href = "index.html";
            }
        });

        window.startGame = function() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-view').classList.remove('hidden');
            setTimeout(() => window.changeDirection({keyCode: 0}), 100); 
            initGame();
        }

        async function loadLeaderboard() {
            if (!navigator.onLine) return; // Nicht laden wenn offline
            const tbody = document.getElementById('leaderboard-body');
            try {
                const q = query(collection(db, "scores"), orderBy("score", "desc"), limit(10));
                const querySnapshot = await getDocs(q);
                tbody.innerHTML = "";
                let rank = 1;
                querySnapshot.forEach((doc) => {
                    const entry = doc.data();
                    let rankDisplay = rank + ".";
                    if(rank === 1) rankDisplay = "ü•á";
                    if(rank === 2) rankDisplay = "ü•à";
                    if(rank === 3) rankDisplay = "ü•â";

                    let row = `<tr><td>${rankDisplay}</td><td style="text-align: left; padding-left: 20px;">${entry.name}</td><td class="highlight">${entry.score}</td></tr>`;
                    tbody.innerHTML += row;
                    rank++;
                });
                if(querySnapshot.empty) tbody.innerHTML = "<tr><td colspan='3'>Noch keine Scores.</td></tr>";
            } catch (e) { console.error(e); tbody.innerHTML = "<tr><td colspan='3'>Fehler...</td></tr>"; }
        }

        async function saveScore(points) {
            if (!navigator.onLine) {
                alert("Du bist offline! Score konnte nicht gespeichert werden.");
                return;
            }
            try {
                await addDoc(collection(db, "scores"), { name: playerName, score: points, date: new Date().toLocaleDateString('de-DE') });
                loadLeaderboard(); 
            } catch (e) { console.error("Save error", e); }
        }

        /* --- SNAKE LOGIK (unver√§ndert) --- */
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        let box = 20;
        let snake = [];
        let food;
        let score = 0;
        let d;
        let game;

        function initGame() {
            snake = []; snake[0] = { x: 9 * box, y: 10 * box };
            score = 0; d = undefined; createFood();
            if(game) clearInterval(game);
            game = setInterval(draw, 100);
        }

        function createFood() {
            food = { x: Math.floor(Math.random() * 19 + 1) * box, y: Math.floor(Math.random() * 19 + 1) * box };
            for(let part of snake) { if(part.x == food.x && part.y == food.y) createFood(); }
        }

        document.addEventListener("keydown", changeDirection);
        function changeDirection(event) {
            let key = event.keyCode;
            if(key == 37 && d != "RIGHT") d = "LEFT";
            else if(key == 38 && d != "DOWN") d = "UP";
            else if(key == 39 && d != "LEFT") d = "RIGHT";
            else if(key == 40 && d != "UP") d = "DOWN";
        }
        window.changeDirection = changeDirection; 

        function draw() {
            ctx.fillStyle = "#000000"; ctx.fillRect(0, 0, canvas.width, canvas.height);
            for(let i = 0; i < snake.length; i++) {
                ctx.fillStyle = "#00ff00"; ctx.strokeStyle = "#000000";
                ctx.fillRect(snake[i].x, snake[i].y, box, box); ctx.strokeRect(snake[i].x, snake[i].y, box, box);
            }
            ctx.fillStyle = "#ff0000"; ctx.fillRect(food.x, food.y, box, box);
            let snakeX = snake[0].x; let snakeY = snake[0].y;
            if(d == "LEFT") snakeX -= box; if(d == "UP") snakeY -= box; if(d == "RIGHT") snakeX += box; if(d == "DOWN") snakeY += box;
            if(snakeX == food.x && snakeY == food.y) { score++; createFood(); } else { snake.pop(); }
            
            let newHead = { x: snakeX, y: snakeY };
            if(snakeX < 0 || snakeX >= canvas.width || snakeY < 0 || snakeY >= canvas.height || collision(newHead, snake)) {
                clearInterval(game);
                saveScore(score);
                alert("Game Over! Score: " + score);
                document.getElementById('start-screen').classList.remove('hidden');
                document.getElementById('game-view').classList.add('hidden');
                return;
            }
            snake.unshift(newHead);
            document.getElementById("score").innerText = score;
        }
        function collision(head, array) { for(let i = 0; i < array.length; i++) { if(head.x == array[i].x && head.y == array[i].y) return true; } return false; }
    </script>
</body>
</html>