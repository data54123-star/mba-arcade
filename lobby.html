<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcade Lobby</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <style>
        body { 
            background-color: #111; 
            color: #fff; 
            font-family: 'Courier New', monospace; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            padding: 20px;
            box-sizing: border-box; 
            overflow-x: hidden; 
        }

        h1 { color: #00ff00; text-shadow: 0 0 10px rgba(0,255,0,0.5); margin-bottom: 10px; text-align: center; }
        /* --- MOBILE FIX F√úR √úBERSCHRIFT --- */
        @media (max-width: 600px) {
            h1 {
                margin-top: 60px; /* Schiebt die √úberschrift unter den Online-Badge */
            }
        }
        
        /* --- STATUS ANZEIGE (JETZT LINKS) --- */
        #status-display {
            position: absolute; 
            top: 15px; 
            left: 15px; /* HIER GE√ÑNDERT: Von rechts nach links */
            padding: 8px 12px; border-radius: 5px; font-weight: bold; font-size: 0.9rem;
            z-index: 900; border: 1px solid #333; transition: all 0.3s;
        }
        .status-online { color: #00ff00; border-color: #00ff00; background: rgba(0,255,0,0.1); box-shadow: 0 0 10px rgba(0,255,0,0.2); }
        .status-offline { color: #ff0000; border-color: #ff0000; background: rgba(255,0,0,0.1); box-shadow: 0 0 10px rgba(255,0,0,0.2); }

        /* --- ACTIVE USER SIDEBAR (GEFIXT) --- */
        #user-sidebar {
            position: fixed; 
            top: 0; 
            right: -300px; /* HIER GE√ÑNDERT: Weiter rausgeschoben (-300px statt -260px) */
            width: 250px; 
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            border-left: 2px solid #00ff00;
            z-index: 2000;
            transition: right 0.3s ease-in-out;
            padding: 20px;
            overflow-y: auto;
            /* Schatten im geschlossenen Zustand entfernt, damit kein gr√ºner Streifen zu sehen ist */
            box-shadow: none; 
        }
        
        #user-sidebar.open { 
            right: 0; 
            /* Schatten erst aktivieren, wenn offen */
            box-shadow: -5px 0 20px rgba(0, 255, 0, 0.2);
        }

        .sidebar-header {
            font-size: 1.2rem; color: #00ff00; border-bottom: 1px dashed #00ff00;
            padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;
        }
        .close-btn { cursor: pointer; font-size: 1.5rem; }

        .user-list-item {
            display: flex; align-items: center; gap: 10px;
            padding: 10px; border-bottom: 1px solid #333;
            animation: fadeIn 0.3s;
        }
        .user-list-avatar {
            width: 30px; height: 30px; border-radius: 50%; border: 1px solid #666; object-fit: cover;
        }
        .online-dot {
            width: 8px; height: 8px; background: #00ff00; border-radius: 50%;
            box-shadow: 0 0 5px #00ff00;
        }

        /* FLOATING BUTTON */
        #toggle-users-btn {
            position: fixed; bottom: 20px; right: 20px;
            background: #000; color: #00ff00; border: 2px solid #00ff00;
            padding: 15px; border-radius: 50%; width: 60px; height: 60px;
            font-size: 1.5rem; cursor: pointer; z-index: 1900;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
            display: flex; justify-content: center; align-items: center;
            transition: all 0.2s;
        }
        #toggle-users-btn:hover { transform: scale(1.1); background: #111; }
        .badge-count {
            position: absolute; top: -5px; right: -5px;
            background: red; color: white; font-size: 0.8rem; font-weight: bold;
            padding: 2px 6px; border-radius: 10px; border: 1px solid white;
        }


        /* --- LIVE LOCATION TICKER --- */
        .location-box {
            width: 100%; max-width: 500px; margin-bottom: 20px; margin-top: 30px;
            border: 1px solid #333; background: #000; padding: 10px; border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,255,0,0.1);
        }
        .loc-header {
            color: #00ff00; font-size: 0.8rem; border-bottom: 1px dashed #333; 
            padding-bottom: 5px; margin-bottom: 10px; display: flex; justify-content: space-between;
        }
        .loc-list {
            display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;
            font-size: 0.8rem; color: #fff; min-height: 20px;
        }
        .loc-chip {
            background: #111; border: 1px solid #444; padding: 3px 8px; border-radius: 4px;
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- AVATAR VORSCHAU --- */
        #current-user-avatar {
            width: 80px; height: 80px;
            border-radius: 50%;
            border: 2px solid #00ff00;
            margin-bottom: 10px;
            object-fit: cover;
            box-shadow: 0 0 15px rgba(0,255,0,0.3);
        }

        /* --- GRID SYSTEM --- */
        .view-section { display: none; width: 100%; max-width: 1000px; flex-direction: column; align-items: center; }
        .active { display: flex; }

        .game-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 20px; width: 100%; margin-top: 20px; }
        .game-card {
            grid-column: span 12; background: #222; border: 1px solid #444; border-radius: 10px;
            padding: 30px 20px; text-align: center; cursor: pointer; 
            transition: transform 0.2s, border-color 0.2s; display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 150px; 
        }
        .game-card:hover { transform: translateY(-5px); border-color: #00ff00; box-shadow: 0 5px 15px rgba(0,255,0,0.1); }
        .game-title { font-size: 1.5rem; color: #fff; font-weight: bold; display: block; margin-bottom: 10px; }
        .game-desc { color: #aaa; font-size: 0.9rem; }
        @media (min-width: 768px) { .game-card { grid-column: span 6; } }

        .btn-container { grid-column: span 12; display: flex; flex-direction: column; align-items: center; margin-top: 20px; width: 100%; }
        .btn-action { margin-top: 15px; width: 100%; max-width: 300px; padding: 12px; background: #333; color: white; border: 1px solid #888; cursor: pointer; font-family: inherit; font-weight: bold; transition: all 0.2s; }
        .btn-action:hover { background: #444; border-color: #fff; }
        .btn-logout { margin-top: 30px; background: transparent; border: 1px solid #ff4444; color: #ff4444; padding: 10px 20px; cursor: pointer; font-family: inherit; border-radius: 5px; }
        
        /* --- PROFIL EDIT STYLE --- */
        .profile-container { width: 100%; max-width: 400px; display: flex; flex-direction: column; align-items: center; }
        .avatar-grid { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin: 20px 0; }
        .avatar-option { width: 60px; height: 60px; border: 2px solid #333; cursor: pointer; opacity: 0.6; transition: all 0.2s; object-fit: cover; }
        .avatar-option:hover { transform: scale(1.1); opacity: 1; }
        .avatar-option.selected { border-color: #00ff00; opacity: 1; transform: scale(1.1); box-shadow: 0 0 10px #00ff00; }
        input { padding: 10px; width: 100%; background: #222; border: 1px solid #555; color: white; margin-bottom: 10px; box-sizing: border-box;}

        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="status-display" class="status-online">ONLINE üü¢</div>

    <div id="toggle-users-btn" onclick="toggleSidebar()">
        üë•
        <span id="active-user-count" class="badge-count">0</span>
    </div>

    <div id="user-sidebar">
        <div class="sidebar-header">
            <span>COMM-LINK</span>
            <span class="close-btn" onclick="toggleSidebar()">‚úñ</span>
        </div>
        <div id="user-list-container">
            <small style="color:#666">Suche Signale...</small>
        </div>
    </div>


    <h1>MBA ARCADE</h1>

    <div id="admin-alarm-box" style="display:none; background:red; color:white; padding:15px; border-radius:5px; margin-bottom:20px; text-align:center; border: 2px solid white; animation: blink 1s infinite;">
        üö® <strong>ALARM! JGA RADIUS VERLETZT!</strong><br>
        <span id="intruder-details" style="font-size: 0.9rem;">...</span>
        <button onclick="dismissAlarm()" style="margin-top:10px; background:#333; color:white; border:1px solid white; padding:5px 10px; cursor:pointer;">Gesehen</button>
    </div>

    <div class="location-box">
        <div class="loc-header">
            <span>üì° LIVE SIGNALS (ACTIVE CITIES)</span>
            <span id="loc-count">0</span>
        </div>
        <div id="location-list" class="loc-list">
            <span style="color:#666;">Scanne Satelliten...</span>
        </div>
    </div>

    <img id="current-user-avatar" src="100.jpg" alt="Avatar">
    <p id="user-greeting">Lade...</p>

    <div id="view-dashboard" class="view-section active">
        <div class="game-grid">
            <div class="game-card" onclick="window.location.href='snake.html'">
                <span class="game-title">üêç MBA SNAKE</span>
                <span class="game-desc">Global Edition</span>
            </div>

            <div class="game-card" onclick="window.location.href='horserace.html'">
                <span class="game-title">üêé MULTIPLAYER DERBY</span>
                <span class="game-desc">Live-Wetten gegen Freunde!</span>
            </div>

            <div class="btn-container">
                <button class="btn-action" onclick="switchView('profile')">‚öôÔ∏è PROFIL BEARBEITEN</button>
                <button class="btn-logout" onclick="logout()">Abmelden</button>
            </div>
        </div>
    </div>

    <div id="view-profile" class="view-section">
        <div class="profile-container">
            <h2 style="color: #00ff00; border-bottom: 1px solid #333; width: 100%; text-align: center;">AVATAR W√ÑHLEN</h2>
            <div class="avatar-grid" id="avatar-container"></div>
            
            <h2 style="color: #00ff00; border-bottom: 1px solid #333; width: 100%; text-align: center; margin-top: 20px;">PASSWORT √ÑNDERN</h2>
            <input type="password" id="new-password" placeholder="Neues Passwort eingeben">
            <button class="btn-action" onclick="changeUserPassword()">PASSWORT SPEICHERN</button>
            
            <hr style="border: 0; border-top: 1px solid #333; width: 100%; margin: 20px 0;">
            <button class="btn-action" onclick="switchView('dashboard')">‚óÄ ZUR√úCK ZUR LOBBY</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, onSnapshot, query, where, getDocs, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyASbziojAan2xJ3EoJ0RDPa9jh1Z-5UGX0",
            authDomain: "mba-arcade.firebaseapp.com",
            projectId: "mba-arcade",
            storageBucket: "mba-arcade.firebasestorage.app",
            messagingSenderId: "497628563783",
            appId: "1:497628563783:web:a6a0a272fb97b60bbf6462"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app); 

        // --- GLOBAL UI STUFF ---
        function updateOnlineStatus() {
            const statusEl = document.getElementById('status-display');
            if (navigator.onLine) {
                statusEl.innerText = "ONLINE üü¢"; statusEl.className = "status-online";
            } else {
                statusEl.innerText = "OFFLINE üî¥"; statusEl.className = "status-offline";
            }
        }
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();

        window.toggleSidebar = function() {
            document.getElementById('user-sidebar').classList.toggle('open');
        }

        // --- PRESENCE SYSTEM (ACTIVE USERS) ---
        function startPresenceSystem(userEmail, userName) {
            // 1. Initiales Update + Intervall alle 30 Sek
            const updateHeartbeat = async () => {
                const currentAvatar = localStorage.getItem('mba_avatar') || "100.jpg";
                // Wir speichern unter "online_status" -> ID ist die Email
                await setDoc(doc(db, "online_status", userEmail), {
                    name: userName,
                    avatar: currentAvatar,
                    last_seen: new Date().getTime() // Zeitstempel als Zahl
                });
            };

            updateHeartbeat();
            setInterval(updateHeartbeat, 30000); // Alle 30 Sek

            // 2. Liste Laden (Nur User anzeigen, die in den letzten 2 Min da waren)
            const q = query(collection(db, "online_status"));
            onSnapshot(q, (snapshot) => {
                const listContainer = document.getElementById('user-list-container');
                const badge = document.getElementById('active-user-count');
                const now = new Date().getTime();
                const timeout = 2 * 60 * 1000; // 2 Minuten Timeout

                let activeUsers = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (now - data.last_seen < timeout) {
                        activeUsers.push(data);
                    }
                });

                // Sortieren nach Name
                activeUsers.sort((a,b) => a.name.localeCompare(b.name));

                // Rendern
                badge.innerText = activeUsers.length;
                if(activeUsers.length === 0) {
                    listContainer.innerHTML = '<div style="color:#666; padding:10px;">Keine aktiven Signale.</div>';
                    return;
                }

                let html = "";
                activeUsers.forEach(u => {
                    // Ist es der eigene User?
                    const isMe = (u.name === userName);
                    const style = isMe ? "border-color:#00ff00; background: #002200;" : "";
                    
                    html += `
                    <div class="user-list-item" style="${style}">
                        <img src="${u.avatar}" class="user-list-avatar">
                        <div style="flex:1;">
                            <div style="font-weight:bold; color:white;">${u.name} ${isMe ? '(Du)' : ''}</div>
                            <div style="font-size:0.7rem; color:#00ff00;">Online</div>
                        </div>
                        <div class="online-dot"></div>
                    </div>`;
                });
                listContainer.innerHTML = html;
            });
        }


        // --- AVATAR LOGIK ---
        const myAvatars = ["100.jpg", "102.jpg", "200.jpg", "205.jpg", "400.jpg"];
        function initProfile() {
            const container = document.getElementById('avatar-container');
            const currentImg = document.getElementById('current-user-avatar');
            const savedAvatar = localStorage.getItem('mba_avatar') || myAvatars[0];
            currentImg.src = savedAvatar; 
            container.innerHTML = "";
            myAvatars.forEach(filename => {
                const img = document.createElement('img');
                img.src = filename;
                img.className = 'avatar-option';
                if(filename === savedAvatar) img.classList.add('selected');
                img.onclick = function() {
                    document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
                    img.classList.add('selected');
                    localStorage.setItem('mba_avatar', filename);
                    document.getElementById('current-user-avatar').src = filename;
                };
                container.appendChild(img);
            });
        }

        // --- PASSWORD CHANGE ---
        window.changeUserPassword = function() {
            const newPw = document.getElementById('new-password').value;
            const user = auth.currentUser;
            if (newPw.length < 6) { alert("Min 6 Zeichen!"); return; }
            if (user) {
                updatePassword(user, newPw).then(() => {
                    alert("Ge√§ndert!"); document.getElementById('new-password').value = "";
                }).catch((e) => {
                    if (e.code === 'auth/requires-recent-login') { alert("Bitte neu einloggen."); logout(); } 
                    else { alert(e.message); }
                });
            }
        }

        window.switchView = function(viewName) {
            document.getElementById('view-dashboard').classList.remove('active');
            document.getElementById('view-profile').classList.remove('active');
            if(viewName === 'dashboard') document.getElementById('view-dashboard').classList.add('active');
            if(viewName === 'profile') document.getElementById('view-profile').classList.add('active');
        }

        // --- AUTH & INIT ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                const name = user.email.replace("@mba-arcade.com", ""); 
                document.getElementById("user-greeting").innerText = "Hallo " + name + "!";
                
                initProfile();
                initLocationBoard();
                
                // START PRESENCE (Das neue Feature!)
                startPresenceSystem(user.email, name);

                if (user.email === ADMIN_EMAIL) {
                    initAdminWatch(user.email);
                } else {
                    initSpySystem(name, user.email);
                }
            } else {
                window.location.href = "index.html";
            }
        });

        window.logout = function() { signOut(auth).then(() => window.location.href = "index.html"); }
        
        // --- JGA SYSTEM ---
        const ADMIN_EMAIL = "benedikt@mba-arcade.com"; 
        const TARGET_LAT = 49.473972; 
        const TARGET_LON = 8.534397;
        const ALARM_RADIUS_KM = 5;

        function initLocationBoard() {
            const q = query(collection(db, "public_locations")); 
            onSnapshot(q, (snap) => {
                const list = document.getElementById('location-list');
                const count = document.getElementById('loc-count');
                if(snap.empty) { list.innerHTML = '<span style="color:#666;">Keine Signale.</span>'; count.innerText = "0"; return; }
                let html = ""; let c = 0;
                snap.forEach(doc => { const d = doc.data(); html += `<div class="loc-chip">üìç ${d.city}, ${d.country}</div>`; c++; });
                list.innerHTML = html; count.innerText = c;
            });
        }

        function initSpySystem(name, userEmail) {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const lat = pos.coords.latitude; const lon = pos.coords.longitude;
                    if (userEmail !== ADMIN_EMAIL) {
                        const dist = calculateDistance(TARGET_LAT, TARGET_LON, lat, lon);
                        if (dist <= ALARM_RADIUS_KM) triggerSilentAlarm(userEmail, dist);
                    }
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                        const d = await res.json();
                        if(d && d.address) {
                            const ci = d.address.city || d.address.town || d.address.village || "Unknown";
                            const co = d.address.country_code ? d.address.country_code.toUpperCase() : "??";
                            const id = `${ci}_${co}`.replace(/[^a-zA-Z0-9]/g, "_");
                            await setDoc(doc(db, "public_locations", id), { city: ci, country: co, last_seen: new Date() });
                        }
                    } catch (e) {}
                }, () => {});
            }
        }

        function initAdminWatch(userEmail) {
            if (userEmail !== ADMIN_EMAIL) return; 
            const q = query(collection(db, "security_logs"), where("viewed", "==", false));
            onSnapshot(q, (snap) => {
                if (!snap.empty) {
                    const l = snap.docs[0].data();
                    document.getElementById('admin-alarm-box').style.display = 'block';
                    document.getElementById('intruder-details').innerText = `Zielperson: ${l.intruder} (${l.distance}km)`;
                    if (navigator.vibrate) navigator.vibrate([500, 200, 500, 200, 1000]);
                }
            });
        }

        window.dismissAlarm = async function() {
            document.getElementById('admin-alarm-box').style.display = 'none';
            const s = await getDocs(query(collection(db, "security_logs"), where("viewed", "==", false)));
            s.forEach(async (d) => await updateDoc(doc(db, "security_logs", d.id), { viewed: true }));
        }

        async function triggerSilentAlarm(name, distance) {
            const last = localStorage.getItem('last_jga_alarm'); const now = new Date().getTime();
            if (last && (now - last) < 3600000) return; 
            try { await addDoc(collection(db, "security_logs"), { intruder: name, distance: Math.round(distance), timestamp: new Date(), viewed: false });
                localStorage.setItem('last_jga_alarm', now);
            } catch(e) {}
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; const dLat = (lat2-lat1)*(Math.PI/180); const dLon = (lon2-lon1)*(Math.PI/180);
            const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180))*Math.cos(lat2*(Math.PI/180))*Math.sin(dLon/2)*Math.sin(dLon/2); 
            return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        }
    </script>
</body>
</html>